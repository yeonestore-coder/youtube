<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ íŠœë¸Œ ëŒ€ë³¸ ìƒì„±ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.6;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 0.95rem;
        }

        .section {
            margin-bottom: 50px;
            padding: 30px;
            border: 2px solid #000;
            background-color: #fafafa;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        /* API í‚¤ ì…ë ¥ ì„¹ì…˜ */
        #api-section {
            display: block;
        }

        #api-section.hidden {
            display: none;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #api-key-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #000;
            font-size: 1rem;
        }

        #api-key-input:focus {
            outline: none;
            background-color: #f0f0f0;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            padding: 12px 24px;
            background-color: #000;
            color: #fff;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

        button:hover {
            background-color: #333;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #fff;
            color: #000;
            border: 2px solid #000;
        }

        .btn-secondary:hover {
            background-color: #f0f0f0;
        }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ì°½ */
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #000;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
        }

        textarea:focus {
            outline: none;
            background-color: #f9f9f9;
        }

        /* ì£¼ì œ ì¶”ì²œ ì¹´ë“œ */
        .topics-container {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .topic-card {
            padding: 20px;
            border: 2px solid #000;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-card:hover {
            background-color: #000;
            color: #fff;
        }

        .topic-card.selected {
            background-color: #000;
            color: #fff;
        }

        .topic-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .topic-description {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 1.1rem;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* ìˆ¨ê¹€ ì²˜ë¦¬ */
        .hidden {
            display: none !important;
        }

        /* ê²°ê³¼ ì„¹ì…˜ */
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .status-message {
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #000;
            background-color: #f0f0f0;
            text-align: center;
        }

        .api-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“¹ ìœ íŠœë¸Œ ëŒ€ë³¸ ìƒì„±ê¸°</h1>
    <p class="subtitle">ê³¼ê±° ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ì¶”ì²œí•˜ê³ , ëŒ€ë³¸ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤</p>

    <!-- API í‚¤ ì…ë ¥ ì„¹ì…˜ -->
    <div id="api-section" class="section">
        <div class="section-title">ğŸ”‘ API í‚¤ ì„¤ì •</div>
        <div class="api-input-group">
            <select id="api-provider" style="padding: 12px; border: 2px solid #000; font-size: 1rem;">
                <option value="gemini">Google Gemini</option>
                <option value="openai">OpenAI</option>
            </select>
            <input type="password" id="api-key-input" placeholder="Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button type="button" id="save-api-key-btn" onclick="saveApiKey()">ì €ì¥</button>
        </div>
        <div class="api-info">
            ğŸ’¡ API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤. Google AI Studio ë˜ëŠ” OpenAIì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <!-- 1. ê³¼ê±° ëŒ€ë³¸ ì…ë ¥ -->
    <div id="input-section" class="section hidden">
        <div class="section-title">1ï¸âƒ£ ê³¼ê±° ëŒ€ë³¸ ì…ë ¥</div>
        <textarea id="past-script" placeholder="ê³¼ê±°ì— ì‘ì„±í–ˆë˜ ìœ íŠœë¸Œ ëŒ€ë³¸ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...&#10;&#10;ì˜ˆì‹œ:&#10;ì•ˆë…•í•˜ì„¸ìš” ì—¬ëŸ¬ë¶„! ì˜¤ëŠ˜ì€ í”„ë¡œê·¸ë˜ë° ì´ˆë³´ìë¥¼ ìœ„í•œ íŒŒì´ì¬ ê¸°ì´ˆì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.&#10;íŒŒì´ì¬ì€ ë°°ìš°ê¸° ì‰½ê³  ê°•ë ¥í•œ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì…ë‹ˆë‹¤..."></textarea>
        <button onclick="analyzeScript()" id="analyze-btn">ì£¼ì œ ì¶”ì²œë°›ê¸° ğŸ¯</button>
    </div>

    <!-- 2. ì£¼ì œ ì¶”ì²œ ê²°ê³¼ -->
    <div id="topics-section" class="section hidden">
        <div class="section-title">2ï¸âƒ£ ì¶”ì²œ ì£¼ì œ ì„ íƒ</div>
        <div id="loading" class="loading hidden">AIê°€ ì£¼ì œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
        <div id="topics-container" class="topics-container"></div>
    </div>

    <!-- 3. ìƒˆ ëŒ€ë³¸ ìƒì„± -->
    <div id="output-section" class="section hidden">
        <div class="result-header">
            <div class="section-title">3ï¸âƒ£ ìƒì„±ëœ ëŒ€ë³¸</div>
        </div>
        <div id="generating" class="loading hidden">ì„ íƒí•œ ì£¼ì œë¡œ ëŒ€ë³¸ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</div>
        <textarea id="new-script" placeholder="ìƒì„±ëœ ëŒ€ë³¸ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
        <div class="button-group">
            <button onclick="copyScript()">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
            <button onclick="downloadScript()">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <!-- 4. ì´ˆê¸°í™” ë²„íŠ¼ -->
    <div id="reset-section" class="section hidden">
        <button class="btn-secondary" onclick="resetAll()" style="width: 100%;">ğŸ”„ ìƒˆë¡œìš´ ì‘ì—… ì‹œì‘í•˜ê¸°</button>
    </div>

    <script>
        // LocalStorage í‚¤ ìƒìˆ˜
        const STORAGE_KEYS = {
            API_KEY: 'api_key',
            API_PROVIDER: 'api_provider',
            PAST_SCRIPT: 'past_script',
            TOPICS: 'recommended_topics',
            SELECTED_TOPIC: 'selected_topic',
            NEW_SCRIPT: 'new_script'
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            loadSavedData();
            updatePlaceholder();
            
            // API ì œê³µì ë³€ê²½ ì‹œ í”Œë ˆì´ìŠ¤í™€ë” ì—…ë°ì´íŠ¸
            document.getElementById('api-provider').addEventListener('change', updatePlaceholder);
            
            // ì €ì¥ ë²„íŠ¼ì— ì¶”ê°€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë°±ì—…)
            const saveBtn = document.getElementById('save-api-key-btn');
            if (saveBtn) {
                console.log('ì €ì¥ ë²„íŠ¼ ì°¾ìŒ, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
                saveBtn.addEventListener('click', function(e) {
                    console.log('ë²„íŠ¼ í´ë¦­ë¨ (addEventListener)');
                    e.preventDefault();
                    saveApiKey();
                });
            } else {
                console.error('ì €ì¥ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
        });

        // í”Œë ˆì´ìŠ¤í™€ë” ì—…ë°ì´íŠ¸
        function updatePlaceholder() {
            const provider = document.getElementById('api-provider').value;
            const input = document.getElementById('api-key-input');
            if (provider === 'gemini') {
                input.placeholder = 'Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            } else {
                input.placeholder = 'OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (sk-...)';
            }
        }

        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSavedData() {
            const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
            const apiProvider = localStorage.getItem(STORAGE_KEYS.API_PROVIDER) || 'gemini';
            
            console.log('í˜ì´ì§€ ë¡œë“œ - API Key ì¡´ì¬:', !!apiKey, 'Provider:', apiProvider);
            
            if (apiKey) {
                // API ì œê³µì ë³µì›
                document.getElementById('api-provider').value = apiProvider;
                
                // API í‚¤ê°€ ìˆìœ¼ë©´ ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
                document.getElementById('api-section').classList.add('hidden');
                document.getElementById('input-section').classList.remove('hidden');
                
                console.log('ì…ë ¥ ì„¹ì…˜ í‘œì‹œë¨');
                
                // ì´ì „ ì‘ì—… ë°ì´í„° ë³µì›
                const pastScript = localStorage.getItem(STORAGE_KEYS.PAST_SCRIPT);
                if (pastScript) {
                    document.getElementById('past-script').value = pastScript;
                }

                const topics = localStorage.getItem(STORAGE_KEYS.TOPICS);
                if (topics) {
                    displayTopics(JSON.parse(topics));
                }

                const newScript = localStorage.getItem(STORAGE_KEYS.NEW_SCRIPT);
                if (newScript) {
                    document.getElementById('new-script').value = newScript;
                    document.getElementById('output-section').classList.remove('hidden');
                    document.getElementById('reset-section').classList.remove('hidden');
                }
            } else {
                console.log('ì €ì¥ëœ API í‚¤ ì—†ìŒ');
            }
        }

        // API í‚¤ ì €ì¥
        function saveApiKey() {
            console.log('saveApiKey í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            const apiKeyInput = document.getElementById('api-key-input');
            const apiProviderSelect = document.getElementById('api-provider');
            
            if (!apiKeyInput || !apiProviderSelect) {
                console.error('ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                alert('ì˜¤ë¥˜: ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const apiKey = apiKeyInput.value.trim();
            const apiProvider = apiProviderSelect.value;
            
            console.log('ì €ì¥ ì‹œë„ - Provider:', apiProvider, 'Key length:', apiKey.length);
            
            if (!apiKey) {
                alert('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (apiProvider === 'openai' && !apiKey.startsWith('sk-')) {
                alert('ì˜¬ë°”ë¥¸ OpenAI API í‚¤ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (sk-ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤)');
                return;
            }

            // ì €ì¥
            try {
                localStorage.setItem(STORAGE_KEYS.API_KEY, apiKey);
                localStorage.setItem(STORAGE_KEYS.API_PROVIDER, apiProvider);
                
                console.log('ì €ì¥ ì™„ë£Œ - LocalStorage í™•ì¸:', 
                    localStorage.getItem(STORAGE_KEYS.API_KEY)?.substring(0, 10) + '...');
                
                // UI ì—…ë°ì´íŠ¸
                const apiSection = document.getElementById('api-section');
                const inputSection = document.getElementById('input-section');
                
                if (apiSection && inputSection) {
                    apiSection.classList.add('hidden');
                    inputSection.classList.remove('hidden');
                    console.log('UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    console.error('ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                }
                
                alert('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
            } catch (error) {
                console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ëŒ€ë³¸ ë¶„ì„ ë° ì£¼ì œ ì¶”ì²œ
        async function analyzeScript() {
            const pastScript = document.getElementById('past-script').value.trim();
            
            if (!pastScript) {
                alert('ê³¼ê±° ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì…ë ¥ ë‚´ìš© ì €ì¥
            localStorage.setItem(STORAGE_KEYS.PAST_SCRIPT, pastScript);

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'ë¶„ì„ ì¤‘...';

            document.getElementById('topics-section').classList.remove('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('topics-container').innerHTML = '';

            try {
                const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
                const apiProvider = localStorage.getItem(STORAGE_KEYS.API_PROVIDER) || 'gemini';
                const topics = await requestTopicsFromAI(pastScript, apiKey, apiProvider);
                
                // ì£¼ì œ ì €ì¥ ë° í‘œì‹œ
                localStorage.setItem(STORAGE_KEYS.TOPICS, JSON.stringify(topics));
                displayTopics(topics);
                
            } catch (error) {
                alert('ì£¼ì œ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                console.error(error);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'ì£¼ì œ ì¶”ì²œë°›ê¸° ğŸ¯';
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // OpenAI APIë¡œ ì£¼ì œ ì¶”ì²œ ìš”ì²­
        async function requestTopicsFromAI(script, apiKey, apiProvider) {
            if (apiProvider === 'gemini') {
                return await requestTopicsFromGemini(script, apiKey);
            } else {
                return await requestTopicsFromOpenAI(script, apiKey);
            }
        }

        // Gemini APIë¡œ ì£¼ì œ ì¶”ì²œ ìš”ì²­
        async function requestTopicsFromGemini(script, apiKey) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-exp-1206:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê³¼ê±° ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ 3ê°€ì§€ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ê° ì£¼ì œëŠ” ì œëª©ê³¼ ê°„ë‹¨í•œ ì„¤ëª…(1-2ë¬¸ì¥)ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”: {"topics": [{"title": "ì£¼ì œ ì œëª©", "description": "ì£¼ì œ ì„¤ëª…"}, ...]}\n\në‹¤ìŒ ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ìœ ì‚¬í•œ ìŠ¤íƒ€ì¼ì˜ ìƒˆë¡œìš´ ì£¼ì œ 3ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”:\n\n${script}`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.8,
                        responseMimeType: "application/json"
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', error);
                throw new Error(error.error?.message || `API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`);
            }

            const data = await response.json();
            console.log('Gemini API ì „ì²´ ì‘ë‹µ:', data);
            
            // ì‘ë‹µ êµ¬ì¡° ê²€ì¦
            if (!data.candidates || data.candidates.length === 0) {
                console.error('API ì‘ë‹µ:', data);
                
                // í• ë‹¹ëŸ‰ ì´ˆê³¼ ë©”ì‹œì§€ í™•ì¸
                if (data.error) {
                    throw new Error(`API ì˜¤ë¥˜: ${data.error.message}`);
                }
                
                throw new Error('AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. API í‚¤ì˜ í• ë‹¹ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¬´ë£Œ í• ë‹¹ëŸ‰ì´ ì†Œì§„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            try {
                const content = JSON.parse(data.candidates[0].content.parts[0].text);xt);
                return content.topics || [];
            } catch (parseError) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
                console.error('ë°›ì€ í…ìŠ¤íŠ¸:', data.candidates[0]?.content?.parts[0]?.text);
                throw new Error('AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // OpenAI APIë¡œ ì£¼ì œ ì¶”ì²œ ìš”ì²­
        async function requestTopicsFromOpenAI(script, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: 'ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê³¼ê±° ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ 3ê°€ì§€ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ê° ì£¼ì œëŠ” ì œëª©ê³¼ ê°„ë‹¨í•œ ì„¤ëª…(1-2ë¬¸ì¥)ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”: [{"title": "ì£¼ì œ ì œëª©", "description": "ì£¼ì œ ì„¤ëª…"}, ...]'
                        },
                        {
                            role: 'user',
                            content: `ë‹¤ìŒ ëŒ€ë³¸ì„ ë¶„ì„í•˜ì—¬ ìœ ì‚¬í•œ ìŠ¤íƒ€ì¼ì˜ ìƒˆë¡œìš´ ì£¼ì œ 3ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”:\n\n${script}`
                        }
                    ],
                    temperature: 0.8,
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API ìš”ì²­ ì‹¤íŒ¨');
            }

            const data = await response.json();
            const content = JSON.parse(data.choices[0].message.content);
            
            // ì‘ë‹µ í˜•ì‹ ì²˜ë¦¬ (ë°°ì—´ ë˜ëŠ” ê°ì²´ì˜ topics ì†ì„±)
            return Array.isArray(content) ? content : (content.topics || []);
        }

        // ì£¼ì œ ì¹´ë“œ í‘œì‹œ
        function displayTopics(topics) {
            const container = document.getElementById('topics-container');
            container.innerHTML = '';

            topics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.innerHTML = `
                    <div class="topic-title">${topic.title}</div>
                    <div class="topic-description">${topic.description}</div>
                `;
                card.onclick = () => selectTopic(topic, index);
                container.appendChild(card);
            });
        }

        // ì£¼ì œ ì„ íƒ
        async function selectTopic(topic, index) {
            // ì„ íƒ í‘œì‹œ
            const cards = document.querySelectorAll('.topic-card');
            cards.forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });

            // ì„ íƒí•œ ì£¼ì œ ì €ì¥
            localStorage.setItem(STORAGE_KEYS.SELECTED_TOPIC, JSON.stringify(topic));

            // ëŒ€ë³¸ ìƒì„± ì„¹ì…˜ í‘œì‹œ
            document.getElementById('output-section').classList.remove('hidden');
            document.getElementById('generating').classList.remove('hidden');
            document.getElementById('new-script').value = '';

            try {
                const pastScript = localStorage.getItem(STORAGE_KEYS.PAST_SCRIPT);
                const apiKey = localStorage.getItem(STORAGE_KEYS.API_KEY);
                const apiProvider = localStorage.getItem(STORAGE_KEYS.API_PROVIDER) || 'gemini';
                const newScript = await generateScript(topic, pastScript, apiKey, apiProvider);
                
                // ìƒì„±ëœ ëŒ€ë³¸ í‘œì‹œ ë° ì €ì¥
                document.getElementById('new-script').value = newScript;
                localStorage.setItem(STORAGE_KEYS.NEW_SCRIPT, newScript);
                
                // ì´ˆê¸°í™” ë²„íŠ¼ í‘œì‹œ
                document.getElementById('reset-section').classList.remove('hidden');
                
            } catch (error) {
                alert('ëŒ€ë³¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('generating').classList.add('hidden');
            }
        }

        // OpenAI APIë¡œ ëŒ€ë³¸ ìƒì„± ìš”ì²­
        async function generateScript(topic, pastScript, apiKey, apiProvider) {
            if (apiProvider === 'gemini') {
                return await generateScriptWithGemini(topic, pastScript, apiKey);
            } else {
                return await generateScriptWithOpenAI(topic, pastScript, apiKey);
            }
        }

        // Gemini APIë¡œ ëŒ€ë³¸ ìƒì„±
        async function generateScriptWithGemini(topic, pastScript, apiKey) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-exp-1206:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê³¼ê±° ëŒ€ë³¸ ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•˜ì—¬, ìƒˆë¡œìš´ ì£¼ì œì— ë§ëŠ” ìœ íŠœë¸Œ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ìì—°ìŠ¤ëŸ½ê³  í¥ë¯¸ë¡œìš°ë©°, ì‹œì²­ìì™€ ì†Œí†µí•˜ëŠ” í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.\n\në‹¤ìŒì€ ì œ ê³¼ê±° ëŒ€ë³¸ì…ë‹ˆë‹¤:\n\n${pastScript}\n\nì´ ìŠ¤íƒ€ì¼ì„ ì°¸ê³ í•˜ì—¬, "${topic.title}" ì£¼ì œë¡œ ìƒˆë¡œìš´ ìœ íŠœë¸Œ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ëŒ€ë³¸ì€ 5-10ë¶„ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2000
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', error);
                throw new Error(error.error?.message || `API ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status})`);
            }

            const data = await response.json();
            console.log('Gemini ëŒ€ë³¸ ìƒì„± ì‘ë‹µ:', data);
            
            // ì‘ë‹µ êµ¬ì¡° ê²€ì¦
            if (!data.candidates || data.candidates.length === 0) {
                console.error('API ì‘ë‹µ:', data);
                
                if (data.error) {
                    throw new Error(`API ì˜¤ë¥˜: ${data.error.message}`);
                }
                
                throw new Error('AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. API í‚¤ì˜ í• ë‹¹ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ë¬´ë£Œ í• ë‹¹ëŸ‰ì´ ì†Œì§„ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
            
            try {
                const text = data.candidates[0].content.parts[0].text;
                return text.trim();
            } catch (accessError) {
                console.error('ì‘ë‹µ ì ‘ê·¼ ì˜¤ë¥˜:', accessError);
                console.error('candidates êµ¬ì¡°:', data.candidates);
                throw new Error('AI ì‘ë‹µ êµ¬ì¡°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // OpenAI APIë¡œ ëŒ€ë³¸ ìƒì„±
        async function generateScriptWithOpenAI(topic, pastScript, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: 'ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ëŒ€ë³¸ ì‘ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ê³¼ê±° ëŒ€ë³¸ ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•˜ì—¬, ìƒˆë¡œìš´ ì£¼ì œì— ë§ëŠ” ìœ íŠœë¸Œ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ìì—°ìŠ¤ëŸ½ê³  í¥ë¯¸ë¡œìš°ë©°, ì‹œì²­ìì™€ ì†Œí†µí•˜ëŠ” í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.'
                        },
                        {
                            role: 'user',
                            content: `ë‹¤ìŒì€ ì œ ê³¼ê±° ëŒ€ë³¸ì…ë‹ˆë‹¤:\n\n${pastScript}\n\nì´ ìŠ¤íƒ€ì¼ì„ ì°¸ê³ í•˜ì—¬, "${topic.title}" ì£¼ì œë¡œ ìƒˆë¡œìš´ ìœ íŠœë¸Œ ëŒ€ë³¸ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ëŒ€ë³¸ì€ 5-10ë¶„ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API ìš”ì²­ ì‹¤íŒ¨');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // ëŒ€ë³¸ ë³µì‚¬
        function copyScript() {
            const script = document.getElementById('new-script').value;
            navigator.clipboard.writeText(script).then(() => {
                alert('ëŒ€ë³¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹');
            }).catch(err => {
                alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
            });
        }

        // ëŒ€ë³¸ ë‹¤ìš´ë¡œë“œ
        function downloadScript() {
            const script = document.getElementById('new-script').value;
            const topic = JSON.parse(localStorage.getItem(STORAGE_KEYS.SELECTED_TOPIC) || '{}');
            const filename = `${topic.title || 'ìƒˆëŒ€ë³¸'}_${new Date().toISOString().slice(0,10)}.txt`;
            
            const blob = new Blob([script], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ì „ì²´ ì´ˆê¸°í™”
        function resetAll() {
            if (!confirm('ëª¨ë“  ì‘ì—… ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            // API í‚¤ë¥¼ ì œì™¸í•œ ëª¨ë“  ë°ì´í„° ì‚­ì œ
            localStorage.removeItem(STORAGE_KEYS.PAST_SCRIPT);
            localStorage.removeItem(STORAGE_KEYS.TOPICS);
            localStorage.removeItem(STORAGE_KEYS.SELECTED_TOPIC);
            localStorage.removeItem(STORAGE_KEYS.NEW_SCRIPT);

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('past-script').value = '';
            document.getElementById('new-script').value = '';
            document.getElementById('topics-container').innerHTML = '';

            // ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('topics-section').classList.add('hidden');
            document.getElementById('output-section').classList.add('hidden');
            document.getElementById('reset-section').classList.add('hidden');

            // ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ì…ë ¥ì°½ ìë™ ì €ì¥ (íƒ€ì´í•‘ ì¤‘)
        document.getElementById('past-script').addEventListener('input', (e) => {
            localStorage.setItem(STORAGE_KEYS.PAST_SCRIPT, e.target.value);
        });
    </script>
</body>
</html>
